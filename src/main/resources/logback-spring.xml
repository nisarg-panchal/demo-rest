<configuration scan="true">

  <!-- Read Spring properties -->
  <springProperty scope="context" name="appName" source="spring.application.name" defaultValue="app"/>
  <springProperty scope="context" name="env"     source="spring.profiles.active"  defaultValue="local"/>

  <!-- Console: human-readable pattern -->
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX} %-5level [%thread] %logger{36} - [%X{correlationId:-}-trace:%X{traceId:-}/%X{spanId:-}] %msg%n</pattern>
    </encoder>
  </appender>

  <!-- File: structured JSON (rolling: daily + 100MB) -->
  <appender name="FILE_JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/app-json.log</file>

    <!-- Modern policy: combines time + size based rolling -->
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <!-- Must include both date and index -->
      <fileNamePattern>logs/app-json-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
      <maxFileSize>100MB</maxFileSize>
      <maxHistory>14</maxHistory>
      <totalSizeCap>3GB</totalSizeCap>
    </rollingPolicy>

    <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
      <providers>
        <timestamp/>
        <version/>

        <!-- Basic fields -->
        <pattern>
          <pattern>
            {
            "level":"%level",
            "logger":"%logger",
            "thread":"%thread",
            "message":"%replace(%msg){'\\n','\\\\n'}",
            "app":"${appName}",
            "env":"${env}"
            }
          </pattern>
        </pattern>

        <!-- All MDC (includes correlationId, etc.) -->
        <mdc/>

        <!-- Throwable -->
        <stackTrace/>

        <!-- Micrometer/Tracing IDs if present in MDC -->
        <pattern>
          <pattern>
            {"traceId":"%X{traceId:-}","spanId":"%X{spanId:-}","correlationId":"%X{correlationId:-}"}
          </pattern>
        </pattern>
      </providers>
    </encoder>
  </appender>

  <!-- Async wrappers (recommended) -->
  <appender name="ASYNC_CONSOLE" class="ch.qos.logback.classic.AsyncAppender">
    <appender-ref ref="CONSOLE"/>
    <queueSize>8192</queueSize>
    <discardingThreshold>0</discardingThreshold>
  </appender>

  <appender name="ASYNC_FILE_JSON" class="ch.qos.logback.classic.AsyncAppender">
    <appender-ref ref="FILE_JSON"/>
    <queueSize>8192</queueSize>
    <discardingThreshold>0</discardingThreshold>
  </appender>

  <!-- Root logger -->
  <root level="INFO">
    <appender-ref ref="ASYNC_CONSOLE"/>
    <appender-ref ref="ASYNC_FILE_JSON"/>
  </root>

  <!-- Optional noise control -->
  <logger name="org.springframework"   level="INFO"/>
  <logger name="org.hibernate.SQL"    level="WARN"/>
</configuration>